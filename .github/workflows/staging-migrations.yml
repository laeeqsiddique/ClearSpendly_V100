name: Staging - Database Migrations

on:
  push:
    branches: [ develop, staging ]
    paths:
      - 'supabase/migrations/**'
      - '.github/workflows/staging-migrations.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'supabase/migrations/**'

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.Right  }}
  SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_STAGING_PROJECT_ID }}
  SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_STAGING_DB_PASSWORD }}

jobs:
  validate-migrations:
    name: Validate Migration Files
    runs-on: ubuntu-latest
    outputs:
      migration-count: ${{ steps.count.outputs.count }}
      has-new-migrations: ${{ steps.changes.outputs.migrations }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Supabase CLI
        run: |
          curl -o supabase.deb https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.deb
          sudo dpkg -i supabase.deb

      - name: Check for migration file changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            migrations:
              - 'supabase/migrations/**'

      - name: Count migration files
        id: count
        run: |
          count=$(find supabase/migrations -name "*.sql" -not -name "*rollback*" | wc -l)
          echo "count=$count" >> $GITHUB_OUTPUT
          echo "Found $count migration files"

      - name: Validate migration file naming
        run: |
          echo "Validating migration file naming convention..."
          invalid_files=()
          
          for file in supabase/migrations/*.sql; do
            if [[ -f "$file" ]]; then
              basename=$(basename "$file")
              # Check if filename follows timestamp pattern (YYYYMMDDHHMMSS_description.sql)
              if [[ ! "$basename" =~ ^[0-9]{14}_[a-zA-Z0-9_-]+\.sql$ ]] && [[ ! "$basename" =~ rollback ]]; then
                echo "Invalid filename format: $basename"
                invalid_files+=("$basename")
              fi
            fi
          done
          
          if [ ${#invalid_files[@]} -gt 0 ]; then
            echo "âŒ Found ${#invalid_files[@]} migration files with invalid naming:"
            printf '%s\n' "${invalid_files[@]}"
            exit 1
          fi
          
          echo "âœ… All migration files follow proper naming convention"

      - name: Check for duplicate migration timestamps
        run: |
          echo "Checking for duplicate migration timestamps..."
          duplicates=$(find supabase/migrations -name "*.sql" -not -name "*rollback*" | \
            xargs -I {} basename {} | \
            sed 's/_.*$//' | \
            sort | uniq -d)
          
          if [ -n "$duplicates" ]; then
            echo "âŒ Found duplicate migration timestamps:"
            echo "$duplicates"
            exit 1
          fi
          
          echo "âœ… No duplicate migration timestamps found"

      - name: Validate SQL syntax
        run: |
          echo "Validating SQL syntax in migration files..."
          npm run deploy:check-migrations

  backup-staging:
    name: Backup Staging Database
    runs-on: ubuntu-latest
    needs: validate-migrations
    if: needs.validate-migrations.outputs.has-new-migrations == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Supabase CLI
        run: |
          curl -o supabase.deb https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.deb
          sudo dpkg -i supabase.deb

      - name: Create database backup
        run: |
          echo "Creating backup of staging database..."
          timestamp=$(date +%Y%m%d_%H%M%S)
          backup_file="staging_backup_${timestamp}.sql"
          
          supabase db dump \
            --project-id $SUPABASE_PROJECT_ID \
            --password $SUPABASE_DB_PASSWORD \
            --file $backup_file
          
          echo "backup_file=$backup_file" >> $GITHUB_ENV
          echo "âœ… Backup created: $backup_file"

      - name: Upload backup to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: staging-db-backup-${{ github.run_id }}
          path: ${{ env.backup_file }}
          retention-days: 30

  run-staging-migrations:
    name: Run Staging Migrations
    runs-on: ubuntu-latest
    needs: [validate-migrations, backup-staging]
    if: needs.validate-migrations.outputs.has-new-migrations == 'true'
    environment: staging
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Supabase CLI
        run: |
          curl -o supabase.deb https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.deb
          sudo dpkg -i supabase.deb

      - name: Link to Supabase project
        run: |
          supabase link \
            --project-ref $SUPABASE_PROJECT_ID \
            --password $SUPABASE_DB_PASSWORD

      - name: Run database migrations
        id: migrate
        run: |
          echo "Running database migrations on staging..."
          
          # Set up error handling
          set -e
          
          # Run migrations with verbose output
          supabase db push --include-all 2>&1 | tee migration_output.log
          
          echo "âœ… Migrations completed successfully"
          
          # Count applied migrations
          applied_count=$(grep -c "Applied migration" migration_output.log || echo "0")
          echo "applied_count=$applied_count" >> $GITHUB_OUTPUT

      - name: Verify migration integrity
        run: |
          echo "Verifying database integrity after migrations..."
          
          # Run basic health checks
          npm run health:db || {
            echo "âŒ Database health check failed after migration"
            exit 1
          }
          
          echo "âœ… Database health check passed"

      - name: Test RLS policies
        run: |
          echo "Testing Row Level Security policies..."
          
          # Run RLS tests if they exist
          if [ -f "supabase/migrations/test_rls_policies.sql" ]; then
            supabase db remote --project-id $SUPABASE_PROJECT_ID < supabase/migrations/test_rls_policies.sql
            echo "âœ… RLS policy tests passed"
          else
            echo "â„¹ï¸ No RLS policy tests found"
          fi

      - name: Update migration status
        run: |
          echo "Migration completed successfully on staging environment"
          echo "Applied ${{ steps.migrate.outputs.applied_count }} migrations"
          
          # Update deployment status
          echo "STAGING_MIGRATION_STATUS=success" >> $GITHUB_ENV
          echo "STAGING_MIGRATION_TIME=$(date -Iseconds)" >> $GITHUB_ENV

      - name: Post migration summary
        uses: actions/github-script@v7
        with:
          script: |
            const appliedCount = '${{ steps.migrate.outputs.applied_count }}';
            const migrationTime = process.env.STAGING_MIGRATION_TIME;
            
            const comment = `## ğŸš€ Staging Migration Complete
            
            âœ… **Status**: Success
            ğŸ“Š **Applied Migrations**: ${appliedCount}
            ğŸ• **Completed**: ${migrationTime}
            ğŸ”— **Environment**: Staging
            
            ### Next Steps
            - Review staging environment functionality
            - Run integration tests
            - Consider promoting to production
            `;
            
            // Post comment on PR if this is a PR
            if (context.payload.pull_request) {
              github.rest.issues.createComment({
                issue_number: context.payload.pull_request.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

  rollback-on-failure:
    name: Rollback on Migration Failure
    runs-on: ubuntu-latest
    needs: [validate-migrations, backup-staging, run-staging-migrations]
    if: failure() && needs.validate-migrations.outputs.has-new-migrations == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Supabase CLI
        run: |
          curl -o supabase.deb https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.deb
          sudo dpkg -i supabase.deb

      - name: Download backup
        uses: actions/download-artifact@v4
        with:
          name: staging-db-backup-${{ github.run_id }}

      - name: Restore from backup
        run: |
          echo "ğŸš¨ Migration failed! Initiating rollback..."
          
          backup_file=$(ls staging_backup_*.sql | head -1)
          
          if [ -f "$backup_file" ]; then
            echo "Restoring from backup: $backup_file"
            npm run deploy:rollback
            echo "âœ… Database restored from backup"
          else
            echo "âŒ No backup file found for rollback"
            exit 1
          fi

      - name: Verify rollback
        run: |
          echo "Verifying database state after rollback..."
          npm run health:db
          echo "âœ… Rollback verification complete"

      - name: Notify team of rollback
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ğŸš¨ Staging Migration Failed - Rollback Complete
            
            âŒ **Status**: Failed
            ğŸ”„ **Action**: Automatic rollback executed
            ğŸ’¾ **Backup**: Database restored from pre-migration backup
            ğŸ• **Rollback Time**: ${new Date().toISOString()}
            
            ### What happened?
            The staging migration encountered an error and was automatically rolled back to prevent data loss.
            
            ### Next Steps
            1. Review the migration failure logs above
            2. Fix the migration issues locally
            3. Test thoroughly before re-running
            4. Consider breaking large migrations into smaller chunks
            `;
            
            if (context.payload.pull_request) {
              github.rest.issues.createComment({
                issue_number: context.payload.pull_request.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }