[build]
builder = "dockerfile"
dockerfilePath = "./Dockerfile"
# Build arguments to pass environment variables (excluding sensitive API keys)
buildArgs = [
  "NEXT_PUBLIC_SUPABASE_URL", 
  "NEXT_PUBLIC_SUPABASE_ANON_KEY", 
  "NEXT_PUBLIC_ENABLE_AI_ENHANCEMENT", 
  "NEXT_PUBLIC_APP_URL", 
  "RAILWAY_ENVIRONMENT", 
  "BUILDING=true"
]
# Remove restrictive watch patterns - deploy on ANY change
# watchPatterns = ["package.json", "package-lock.json", "next.config.ts", "tsconfig.json", "Dockerfile", "components/**", "app/**", "lib/**"]

[build.environment]
NODE_ENV = "production"
NEXT_TELEMETRY_DISABLED = "1"
CI = "true"
NODE_OPTIONS = "--max-old-space-size=4096"
DISABLE_ESLINT_PLUGIN = "true"
# Prevent npm audit during build for speed
NPM_CONFIG_AUDIT = "false"
NPM_CONFIG_FUND = "false"
# Use specific Node.js version
NIXPACKS_NODE_VERSION = "20"

[deploy]
startCommand = "node server.js"
healthcheckPath = "/api/health"
healthcheckTimeout = 300
restartPolicyType = "on_failure"
restartPolicyMaxRetries = 3
# Increase memory allocation for Railway
numReplicas = 1

[deploy.environment]
NODE_ENV = "production"
PORT = "3000"
HOSTNAME = "0.0.0.0"
RAILWAY_ENVIRONMENT = "production"
NEXT_TELEMETRY_DISABLED = "1"
NODE_OPTIONS = "--max-old-space-size=2048"
# Optimize for Railway infrastructure
UV_THREADPOOL_SIZE = "4"

[scaling]
minReplicas = 1
maxReplicas = 3
# CPU and memory scaling thresholds
autoscaling = true
cpuThreshold = 80
memoryThreshold = 85

# Railway-specific optimization settings
[experimental]
enableBuildCache = true
incrementalBuilds = true